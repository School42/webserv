# MAIN SERVER CONFIGURATION
# Defines core behavior of the HTTP server instance
# - Each 'server' block can host multiple domains/ports (virtual hosting)
# - First server block becomes default for its host:port combination
# - Subject requires support for multiple server blocks

# NETWORK CONFIGURATION
# Controls how clients connect to the server
# - 'listen' is mandatory (subject requires multiple port support)
# - 'client_max_body_size' is required for POST handling

# ERROR PAGES
# Custom responses for HTTP error conditions
# - Must provide default error pages (400, 403, 404, 500)
# - Files must exist in the specified root directory

# ROOT LOCATION (/)
# Handles static file serving
# - GET/POST/DELETE allowed_methods (subject requirement)
# - Static file delivery (primary server function)
# - autoindex for directory listing (testing)

# UPLOAD LOCATION (/upload)
# Handles file uploads via POST
# - Must specify upload storage directory (upload_store)
# - Should restrict to POST method only
# - Validate file types/sizes in implementation

# REDIRECTION LOCATION (/redirect)
# Demonstrates HTTP 301 redirects
# - Verify server handles status codes correctly
# - Relative paths are resolved against server root

# PHP-CGI LOCATION (~ \.php$)
# Executes PHP scripts via CGI
# - Must support at least one CGI (php-cgi shown)
# - Must use execve() with absolute path
# - Must handle PATH_INFO and chunked encoding
# - Scripts execute in their directory context

server {
	listen 8080;
	host 127.0.0.1;
	server_name temu.com;
	client_max_body_size 2M;

	# Error pages (required)
	error_page 400 /errors/400.html;	# Bad Request
	error_page 403 /errors/403.html;	# Forbidden
	error_page 404 /errors/404.html;	# Not Found
	error_page 405 /errors/405.html;	# Method Not ALlowed
	error_page 500 /errors/500.html;	# Internal Server Error

	# ROOT LOCATION (/) (required)
	location 		/		 {
		root www;
		index index.html;
		allowed_methods GET POST DELETE;
		autoindex off;
	}

	# UPLOAD LOCATION (required)
	location /upload {
		root uploads;		# base director for upload paths
		allowed_methods POST DELETE;				# POST for uploads, DELETE for file deletion
		upload_store uploads;	# where to save upload files
	}

	# REDIRECTION LOCATION (optional)
	location /redirect {
		return 301 /new-location;
		allowed_methods GET;					# redirects usually only need GET
	}

	# PHP-CGI LOCATION (~ \.php$) (required)
	location /cgi-bin {
		root cgi-bin;
		allowed_methods GET POST DELETE;
		cgi_pass /usr/bin/php-cgi;
		# cgi_extension .php;
		autoindex on;
		client_max_body_size 2M;
	}
}

server {

    listen 9081;
    server_name localhost;
    host 127.0.0.1;
    client_max_body_size 1000;
    # error_page 404 www/errors/404.html;
    # error_page 500 www/errors/500.html;    # error_page 404 www/errors/404.html;
    # error_page 500 www/errors/500.html;

    location / {
        root www;
        index index.html; # hello.html
        client_max_body_size 1000;
        allowed_methods POST DELETE GET;
    }

    location /upload {
        root uploads;
        allowed_methods GET POST DELETE;
        client_max_body_size 800;
        upload_store uploads;
        autoindex on;
    }

    location /cgi-bin {
        autoindex on;
        root cgi-bin;
        allowed_methods GET POST;
        cgi_pass /usr/bin/php-cgi;
        cgi_pass /usr/bin/python3;
		# cgi_extension .cgi;
    }

    location /redirect {
        return 301 /;
    }
}

server {
    listen 9091;
    server_name test.local;
    host 127.0.0.1;
    client_max_body_size 15;

    location / {
        root www;
        index test.html;
        allowed_methods GET;
    }
}


# Basic testing
# valgrind \
#   --tool=memcheck \
#   --leak-check=full \
#   --show-leak-kinds=all \
#   --track-origins=yes \
#   --track-fds=yes \
#   --num-callers=20 \
#   --verbose \
#   --log-file=valgrind_webserv.log \
#   ./webserv

# QUICK CHECK (faster, less detailed)
# valgrind \
#   --tool=memcheck \
#   --leak-check=summary \
#   --track-fds=yes \
#   --error-exitcode=1 \
#   ./webserv

# valgrind: $(NAME)
# 	valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all \
# 	--track-origins=yes --track-fds=yes --num-callers=20 \
# 	--log-fi
# Basic testing
# valgrind \
#   --tool=memcheck \
#   --leak-check=full \
#   --show-leak-kinds=all \
#   --track-origins=yes \
#   --track-fds=yes \
#   --num-callers=20 \
#   --verbose \
#   --log-file=valgrind_webserv.log \
#   ./webserv

# QUICK CHECle=valgrind.log ./$(NAME)

# valgrind-verbose: $(NAME)
# 	valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all \
# 	--track-origins=yes --track-fds=yes --num-callers=30 \
# 	--keep-stacktraces=alloc-and-free --freelist-vol=100000 \
# 	--malloc-fill=0xAB --free-fill=0xCD --verbose \
# 	--log-file=valgrind_verbose.log ./$(NAME)

# WEB SERVER SPECIFIC TESTING COMMANDS:
# Test with curl while valgrind is running:
# curl -X GET http://localhost:8080/
# curl -X POST http://localhost:8080/ -d "test data"
# curl -v -F "file=@/home/ykai-yua/Downloads/gigader.jpeg" http://localhost:8080/cgi-bin/upload.cgi
# curl -v -F "file=@/home/ykai-yua/Desktop/42_webserv/project/testfile/ratchef.gif" http://localhost:8080/cgi-bin/upload.cgi
# curl -X DELETE http://localhost:8080/test
# curl -X DELETE http://localhost:8080/uploads\?file=upload_test
# curl -v -X DELETE "http://localhost:8080/cgi-bin/upload.cgi?file=gigader.jpeg" 
# siege -c 10 -t 30s http://localhost:8080/  # Load testing
